<!-- templates/dashboard/index.html -->
{% extends "base.html" %}

{% block title %}Dashboard - Trading{% endblock %}

{% block content %}
<div class="row g-4">
    
    <!-- Market Overview -->
    <div class="col-lg-8">
        <div class="card card-trading h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Market Overview
                </h5>
                <span class="badge bg-primary">{{ tickers_count }} Tickers</span>
            </div>
            <div class="card-body">
                <!-- Price Chart -->
                <div class="mb-4">
                    <canvas id="marketChart" height="100"></canvas>
                </div>
                
                <!-- Top Movers -->
                <h6 class="mb-3"><i class="fas fa-fire me-2"></i>Top Movers</h6>
                <div class="row g-2">
                    {% for stock in market_data[:8] %}
                    <div class="col-md-6 col-lg-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title mb-1">{{ stock.ticker }}</h6>
                                        <p class="card-text text-muted small">${{ "%.2f"|format(stock.price) }}</p>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge {% if stock.change_pct > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if stock.change_pct > 0 %}+{% endif %}{{ "%.2f"|format(stock.change_pct) }}%
                                        </span>
                                        <div class="text-muted small">Vol: {{ "{:,}"|format(stock.volume) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Portfolio Summary & Quick Actions -->
    <div class="col-lg-4">
        <div class="row g-4">
            
            <!-- Portfolio Summary -->
            <div class="col-12">
                <div class="card card-trading">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-wallet me-2"></i>Portfolio Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if portfolio_summary %}
                        <div class="text-center mb-3">
                            <h3 class="text-primary">${{ "{:,.2f}"|format(portfolio_summary.total_value) }}</h3>
                            <p class="text-muted mb-0">Total Value</p>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold">${{ "{:,.0f}"|format(portfolio_summary.cash_balance) }}</div>
                                    <small class="text-muted">Cash</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold">{{ portfolio_summary.positions_count }}</div>
                                    <small class="text-muted">Positions</small>
                                </div>
                            </div>
                        </div>
                        
                        <a href="{{ url_for('portfolio.index') }}" class="btn btn-primary w-100 mt-3">
                            <i class="fas fa-eye me-2"></i>View Details
                        </a>
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-plus-circle fa-3x mb-3 opacity-50"></i>
                            <p>No portfolio found</p>
                            <a href="{{ url_for('portfolio.index') }}" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-2"></i>Create Portfolio
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="col-12">
                <div class="card card-trading">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('signals.index') }}" class="btn btn-outline-warning">
                                <i class="fas fa-signal me-2"></i>Generate Signals
                            </a>
                            <a href="{{ url_for('backtest.index') }}" class="btn btn-outline-info">
                                <i class="fas fa-chart-bar me-2"></i>Run Backtest
                            </a>
                            <a href="{{ url_for('query.index') }}" class="btn btn-outline-success">
                                <i class="fas fa-search me-2"></i>Query Data
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="col-12">
                <div class="card card-trading" 
                     id="health-status"
                     hx-get="{{ url_for('main.health_check') }}" 
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <div class="card-body text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Checking system status...</p>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Market Chart
const chartDataRaw = {{ chart_data|safe }};
if (chartDataRaw && chartDataRaw.length > 0) {
    const ctx = document.getElementById('marketChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartDataRaw.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [{
                label: 'Price',
                data: chartDataRaw.map(d => d.price),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                },
                x: {
                    ticks: {
                        maxTicksLimit: 6
                    }
                }
            }
        }
    });
}

// Health status response handler
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'health-status') {
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            const isHealthy = response.status === 'healthy';
            
            document.getElementById('health-status').innerHTML = `
                <div class="card-body text-center">
                    <i class="fas fa-${isHealthy ? 'check-circle text-success' : 'exclamation-triangle text-danger'} fa-2x mb-2"></i>
                    <div class="fw-bold">${isHealthy ? 'System Healthy' : 'System Issues'}</div>
                    <small class="text-muted">
                        DB: ${response.database || 'Unknown'}<br>
                        Last Data: ${response.last_data_date || 'N/A'}
                    </small>
                </div>
            `;
        } catch (e) {
            console.error('Health check error:', e);
        }
    }
});
</script>
{% endblock %}